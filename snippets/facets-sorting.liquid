{% comment %}
    Renders facets (filtering and sorting)

    Accepts:
    - results: {Object} Collection or Search object
    - enable_filtering: {Boolean} Show filtering when true
    - enable_sorting: {Boolean} Show sorting when true
    - collapse_on_larger_devices: {Boolean} Collapse filtering/sorting into menu on larger devices when true

    Usage:
    {% render 'facets', results: collection, enable_filtering: true, enable_sorting: true, collapse_on_larger_devices: false %}
{% endcomment %}

{%- liquid
	assign sort_by = results.sort_by | default: results.default_sort_by
	assign total_active_values = 0
	if results.url
	  assign results_url = results.url
	else
	  assign terms = results.terms | escape
	  assign results_url = '?q=' | append: terms | append: '&options%5Bprefix%5D=last&sort_by=' | append: sort_by
	endif
  -%}

  {% liquid
    if results.results_count
      assign results_count_total = results.results_count
      if result_total_hide_product
        assign results_count_total = results_count_total | minus: result_total_hide_product
      endif
    endif
  %}

  <div class="facets-container">

	<span style="display: none;" id="ProductCount">
		{%- if results.results_count -%}
			{{ 'templates.search.results_with_count' | t: terms: results.terms, count: results_count_total }}
			{%- elsif results.products_count == results.all_products_count -%}
			{{ 'products.facets.product_count_simple' | t: count: results.products_count }}
			{%- else -%}
			{{ 'products.facets.product_count' | t: product_count: results.products_count, count: results.all_products_count }}
		{%- endif -%}
	</span>
	{%- unless collapse_on_larger_devices -%}
	  <facet-filters-form class="facets">
		<form id="FacetFiltersForm-Sorting" class="facets__form facets__form-sorting">
			<div>
			<h2 class="product-count__text text-body">
				<span id="ProductCountDesktop">
				  {%- if results.results_count -%}
					{{ 'templates.search.results_with_count' | t: terms: results.terms, count: results_count_total }}
				  {%- elsif results.products_count == results.all_products_count -%}
					{{ 'products.facets.product_count_simple' | t: count: results.products_count }}
				  {%- else -%}
					{{ 'products.facets.product_count' | t: product_count: results.products_count, count: results.all_products_count }}
				  {%- endif -%}
				</span>
			  </h2>
			<div class="active-facets active-facets-desktop">
				{%- for filter in results.filters -%}
					{%- for value in filter.active_values -%}
					<facet-remove>
						<a href="{{ value.url_to_remove }}" class="active-facets__button active-facets__button--light">
						<span data-filter-remove="{{ value.label }}" class="collection-new-filter">
							{{ value.label | escape }}
							{% render 'icon-close-small' %}
						</span>
						</a>
					</facet-remove>
					{%- endfor -%}
					{% if filter.type == "price_range" %}
					{%- if filter.min_value.value != nil or filter.max_value.value != nil -%}
						<facet-remove>
						<a href="{{ filter.url_to_remove }}" class="active-facets__button active-facets__button--light">
							<span id="priceRemoveFilter" class="collection-new-filter">
							{%- if filter.min_value.value -%}{{ filter.min_value.value | money }}{%- else -%}{{ 0 | money }}{%- endif -%}-{%- if filter.max_value.value -%}{{ filter.max_value.value | money }}{%- else -%}{{ filter.range_max | money }}{%- endif -%}
							{% render 'icon-close-small' %}
							</span>
						</a>
						</facet-remove>
					{%- endif -%}
					{% endif %}
				{%- endfor -%}
				{%- for filter in results.filters -%}
                  {%- for value in filter.active_values -%}
					<facet-remove class="active-facets__button-wrapper">
						<a href="{{ results_url }}" class="active-facets__button-remove underlined-link">
						<span>{{ 'products.facets.clear_all' | t }}</span>
						</a>
					</facet-remove>
    			  {%- endfor -%}
                {%- endfor -%}
				</div>
			</div>
		  {%- if enable_sorting -%}
			<div class="facet-filters sorting caption">
			  <div class="facet-filters__field">
				<div class="select">
				  {%- assign sort_by = results.sort_by | default: results.default_sort_by -%}
				  <select name="sort_by" class="facet-filters__sort select__select caption-large" id="SortBy" aria-label="Sort By" aria-describedby="a11y-refresh-page-message">
					{%- for option in results.sort_options -%}
						{%- unless option.name contains "Price" -%}
							  <option value="{{ option.value | escape }}"{% if option.value == sort_by %} selected="selected"{% endif %}>{{ option.name | escape }}</option>
						{%- endunless -%}
					{%- endfor -%}
				  </select>
				</div>
			  </div>

			  <noscript>
				<button type="submit" class="facets__button-no-js button button--tertiary">{{ 'products.facets.sort_button' | t }}</button>
			  </noscript>
			</div>
		  {%- endif -%}
		</form>
	  </facet-filters-form>
	{%- endunless -%}
  </div>
