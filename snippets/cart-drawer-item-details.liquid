{% comment %} Wholesale_Club_Item_Prices Start {% endcomment %}
{% if item.product %}
  {% assign base_product = item.product %}
{% else %}
  {% assign base_product = item %}
{% endif %}

{% if item.variant %}
  {% assign base_variant = item.variant %}
{% else %}
  {% assign base_variant = item.selected_or_first_available_variant %}
{% endif %}

{% if shop.metafields.sawholesale['base_price'] == blank %}
    {% assign base_price = 'compare_at_price' %}
{% else %}
    {% assign base_price = shop.metafields.sawholesale['base_price'] %}
{% endif %}

{% assign saw_discount = 0 %}{% assign saw_has_discount = false %}

{% if customer.tags != blank %}
    {% for mf in base_product.metafields.sawholesale %}
        {% capture product_customer_tag %}{{ mf | first | replace: 'discount_', '' }}{% endcapture %}
        {% if customer.tags contains product_customer_tag %}
            {% assign saw_has_discount = true %}
            {% assign discount_key = product_customer_tag | prepend: 'discount_' %}
            {% assign price_key = product_customer_tag | prepend: 'price_' %}
            {% assign saw_discount = base_product.metafields.sawholesale[discount_key] | divided_by: 100.0 %}
        {% endif %}
    {% endfor %}
{% endif %}

{% assign saw_discount = 1 | minus: saw_discount %}

{% if base_price == 'price' or base_variant.compare_at_price == blank  or base_variant.compare_at_price == 0 or base_variant.compare_at_price < base_variant.price %}
    {% assign saw_variant_compare_at_price = base_variant.price %}
{% else %}
    {% assign saw_variant_compare_at_price = base_variant.compare_at_price %}
{% endif %}

{% assign cpe = shop.metafields.sawholesale['cpe'] | default: "true" %}
{% if base_variant.metafields.sawholesale[price_key] != blank and cpe == "true" %}
    {% assign saw_variant_price = base_variant.metafields.sawholesale[price_key] %}
{% else %}
    {% assign saw_variant_price = saw_variant_compare_at_price | times: saw_discount %}
{% endif %}

{% if saw_has_discount == false or saw_variant_price >= saw_variant_compare_at_price %}
    {% assign WCItem_OriginalPrice = item.original_price %}
    {% assign WCItem_FinalPrice = item.final_price %}
    {% assign WCItem_Price = item.price %}
    {% assign WCItem_PriceMin = item.price_min %}
    {% assign WCItem_PriceMax = item.price_max %}
    {% assign WCItem_CompareAtPrice = item.compare_at_price %}
    {% assign WCItem_CompareAtPriceMin = item.compare_at_price_min %}
    {% assign WCItem_CompareAtPriceMax = item.compare_at_price_max %}
    {% assign WCItem_OriginalLinePrice = item.original_line_price %}
    {% assign WCItem_FinalLinePrice = item.final_line_price %}
    {% assign WCItem_LinePrice = item.line_price %}
{% else %}
    {% assign WCItem_OriginalPrice = saw_variant_compare_at_price %}
    {% assign WCItem_FinalPrice = saw_variant_price %}
    {% assign WCItem_Price = saw_variant_price %}
    {% assign WCItem_PriceMin = item.price_min | times: saw_discount %}
    {% assign WCItem_PriceMax = item.price_max | times: saw_discount %}
    {% assign WCItem_CompareAtPrice = saw_variant_compare_at_price %}
    {% if base_product.compare_at_price_min != 0 %}{% assign WCItem_CompareAtPriceMin = base_product.compare_at_price_min %}{% else %}{% assign WCItem_CompareAtPriceMin = base_product.price_min %}{% endif %}
    {% if base_product.compare_at_price_max != 0 %}{% assign WCItem_CompareAtPriceMax = base_product.compare_at_price_max %}{% else %}{% assign WCItem_CompareAtPriceMax = base_product.price_max %}{% endif %}
    {% assign WCItem_OriginalLinePrice = WCItem_OriginalPrice | round | times: item.quantity %}
    {% assign WCItem_FinalLinePrice = WCItem_FinalPrice | round | times: item.quantity %}
    {% assign WCItem_LinePrice = WCItem_Price | round | times: item.quantity %}
{% endif %}
{% comment %} Wholesale_Club_Item_Prices End {% endcomment %}

{% liquid
  assign productType = item.product.type | downcase | replace: ' ', '_' | slice: 0, 20
  if item.product.variants.size > 1
      assign productPrice = item.variant.price | money_without_currency
      assign productComparePrice = item.variant.compare_at_price | money_without_currency
      assign productPricePerMetresSquared = item.variant.metafields.product_config.price_per_metres_squared
      assign productLength = item.variant.metafields.filters.length
      assign productRollWidth = item.variant.metafields[productType].roll_width
  else
      assign productPrice = item.product.price | money_without_currency
      assign productComparePrice = item.product.compare_at_price | money_without_currency
      assign productPricePerMetresSquared = item.product.metafields.product_config.price_per_metres_squared
      assign productLength = item.variant.metafields.filters.length
      assign productRollWidth = item.product.metafields[productType].roll_width
  endif

  assign productMinQty = item.variant.metafields.product_config.minimum_qty | plus: 0
  assign productWidth = item.variant.metafields.product_attribute.width

  assign productPackSize = item.variant.metafields.product_attribute.pack_size
  assign itemCollections = item.product
  assign colCount = itemCollections.collections.size
%}

<td class="cart-item__details" role="cell" headers="CartDrawer-ColumnProduct">
  {%- if settings.show_vendor -%}
    <p class="caption-with-letter-spacing light">{{ item.product.vendor }}</p>
  {%- endif -%}

  {%- if item.original_price != item.final_price -%}
    <div class="cart-item__discounted-prices">
      <span class="visually-hidden">
        {{ 'products.product.price.regular_price' | t }}
      </span>
      <s class="cart-item__old-price product-option">
        {{- item.original_price | money -}}
      </s>
      <span class="visually-hidden">
        {{ 'products.product.price.sale_price' | t }}
      </span>
      <strong class="cart-item__final-price product-option">
        {{ item.final_price | money }}
      </strong>
    </div>
  {%- else -%}
    <div class="product-option">
      {{ 'products.product.price.unit_price' | t }}:  <span class="single_p">  {{ item.original_price | money }} </span>
      
    </div>
  {%- endif -%}

  {% unless isSampleItem %}
    {% if item.variant.metafields.product_config.sale_metric == 'Pack' %}
      {% if productWidth and productLength %}
        <div class="product-option">Plank/Tile Size: {{ productWidth }} x {{ productLength }}</div>
      {% endif %}
      {%- if productPackSize != blank -%}
        <div class="product-option">Pack Size: {{ productPackSize }}m²</div>
      {%- endif -%}
    {% elsif item.variant.metafields.product_config.sale_metric == 'Board' %}
      {% if productWidth and productLength %}
        <div class="product-option">Board Length: {{ productLength }}m</div>
        <div class="product-option">Board Width: {{ productWidth }}mm</div>
      {% endif %}
    {% elsif item.variant.metafields.product_config.sale_metric == 'Roll' %}
      <div class="product-option">Roll Size: {{ productRollWidth }}m x {{ item.quantity }}m</div>
    {% endif %}
    {% if productPricePerMetresSquared and productPackSize != blank %}
      <div class="product-option">Price Per Metre: <span class="js-price-per-metres-squared">{{ productPricePerMetresSquared | times: 100 | money }}</span>/m² inc VAT</div>
    {% endif %}
    {% if item.variant.metafields.product_config.sale_metric == 'Pack' and productPackSize != blank %}
      <div class="product-option">Total m² Required: <span class="js-metres-squared-required">{{ item.quantity | times: productPackSize }}</span>m²</div>
    {% elsif item.variant.metafields.product_config.sale_metric == 'Board' %}
      {% if productWidth and productLength %}
        {% comment %} Board width is provided in millimetres, convert to metres. e.g. 145mm = 0.145m {% endcomment %}
        {% assign boardWidthMetres = productWidth | divided_by: 1000.0 %}
        {% comment %} Calculate m² from board dimensions (length(m) * width(m)) {% endcomment %}
        {% assign boardDimensons = productLength | times: boardWidthMetres %}
        {% comment %} Calculate the required m² (quantity * board m²) {% endcomment %}
        {% assign boardMetresRequired = item.quantity | times: boardDimensons %}
        <div class="product-option">Total m² Required: <span class="js-metres-squared-required">{{ boardMetresRequired }}</span>m²</div>
        <div class="product-option">Total Length Required: {{ productLength | times: item.quantity | round: 2 }}m</div>
      {% endif %}
    {% elsif item.variant.metafields.product_config.sale_metric == 'Roll' %}
      <div class="product-option">Total m² Required: <span class="js-metres-squared-required">{{ item.quantity | times: productRollWidth }}</span>m²</div>
    {% endif %}
  {% endunless %}

  {%- if item.product.has_only_default_variant == false
    or item.properties.size != 0
    or item.selling_plan_allocation != null
  -%}
    <dl>
      {%- if item.product.has_only_default_variant == false -%}
        {%- for option in item.options_with_values -%}
          {% unless isSampleItem and option.name == 'Title' %}
            <div class="product-option">
              <dt>{{ option.name }}:</dt>
              <dd>
                {{ option.value -}}
                {%- unless forloop.last %}, {% endunless %}
              </dd>
            </div>
          {% endunless %}
        {%- endfor -%}
      {%- endif -%}

      {%- for property in item.properties -%}
        {%- assign property_first_char = property.first | slice: 0 -%}
        {%- if property.last != blank and property_first_char != '_' -%}
          <div class="product-option">
            <dt>{{ property.first }}:</dt>
            <dd>
              {%- if property.last contains '/uploads/' -%}
                <a
                  href="{{ property.last }}"
                  class="link"
                  target="_blank"
                  aria-describedby="a11y-new-window-message"
                >
                  {{ property.last | split: '/' | last }}
                </a>
              {%- else -%}
                {{ property.last }}
              {%- endif -%}
            </dd>
          </div>
        {%- endif -%}
      {%- endfor -%}
    </dl>

    <p class="product-option">{{ item.selling_plan_allocation.selling_plan.name }}</p>
  {%- endif -%}

  <ul
    class="discounts list-unstyled"
    role="list"
    aria-label="{{ 'customer.order.discount' | t }}"
  >
    {%- for discount in item.line_level_discount_allocations -%}
      <li class="discounts__discount">
        {%- render 'icon-discount' -%}
        {{ discount.discount_application.title }}
      </li>
    {%- endfor -%}
  </ul>
</td>
