{% comment %}
    Renders facets (filtering and sorting)

    Accepts:
    - results: {Object} Collection or Search object
    - enable_filtering: {Boolean} Show filtering when true
    - enable_sorting: {Boolean} Show sorting when true
    - collapse_on_larger_devices: {Boolean} Collapse filtering/sorting into menu on larger devices when true

    Usage:
    {% render 'facets', results: collection, enable_filtering: true, enable_sorting: true, collapse_on_larger_devices: false %}
{% endcomment %}

{%- liquid
	assign sort_by = results.sort_by | default: results.default_sort_by
	assign total_active_values = 0
	if results.url
	  assign results_url = results.url
	else
	  assign terms = results.terms | escape
	  assign results_url = '?q=' | append: terms | append: '&options%5Bprefix%5D=last&sort_by=' | append: sort_by
	endif
  -%}

  <div class="facets-container">
	{%- unless collapse_on_larger_devices -%}
	  <facet-filters-form class="facets">
		<form id="FacetFiltersForm" class="facets__form">
			<div class="facets__mobile-sort-refine-container">
				<div id="mobileRefineBy" class="mobile-refine-by">
					<span>
                        {% render 'filter-icon' %}
						Refine
					</span>
				</div>
				{%- if enable_sorting -%}
					<div class="mobile-facets__details js-filter" data-index="mobile-{{ forloop.index }}">
						<div class="mobile-facets__summary">
							<div class="mobile-facets__sort">
							<div class="select">
								<select name="sort_by" class="select__select" id="SortBy-mobile" aria-label="Sort By" aria-describedby="a11y-refresh-page-message">
								{%- for option in results.sort_options -%}
									{%- unless option.name contains "Price" -%}
										<option value="{{ option.value | escape }}"{% if option.value == sort_by %} selected="selected"{% endif %}>{{ option.name | escape }}</option>
									{%- endunless -%}
								{%- endfor -%}
								</select>
							</div>
							</div>
						</div>
					</div>
				{%- endif -%}
			</div>
		  {%- if results.terms -%}
			<input type="hidden" name="q" value="{{ results.terms | escape }}">
			<input name="options[prefix]" type="hidden" value="last">
		  {%- endif -%}

		  {% if enable_filtering %}
			<div id="FacetsWrapperDesktop" class="facets__wrapper facets__mobile-none">
              <span class="filter-close-mobile"></span>
              <p class="mobile-filter-heading">Filter By</p>
			  {%- for filter in results.filters -%}
				{%- assign total_active_values = total_active_values | plus: filter.active_values.size -%}
				{% case filter.type %}
				{% when 'list' %}
					<div id="Facet-{{ forloop.index }}-{{ section.id }}" class="facets-element js-filter" data-index="{{ forloop.index }}">
					  <div class="facets__header">
						<span class="facets__header-title">
							{%- if filter.label == "Brand" -%}
								{{ 'products.facets.brands' | t }}
							{%- else -%}
								{{ filter.label }}
							{%- endif -%}
						</span>
					  </div>
					  <ul class="facets__list list-unstyled" role="list">
						{%- for value in filter.values -%}
                          {% unless value.param_name == 'filter.p.product_type' and value.value == 'Product Sample Item' %}
                            <li class="list-menu__item facets__item">
                            <label for="Filter-{{ filter.label | escape }}-{{ forloop.index }}" class="facet-checkbox{% if value.count == 0 and value.active == false %} facet-checkbox--disabled{% endif %}">
                              <input type="checkbox"
                              name="{{ value.param_name }}"
                              value="{{ value.value }}"
                              id="Filter-{{ filter.label | escape }}-{{ forloop.index }}"
                              data-filter-label="{{ value.label }}"
                              {% if value.active %}checked{% endif %}
                              {% if value.count == 0 and value.active == false %}disabled{% endif %}
                              >
                              <span>
                                {% assign value_count = value.count %}
                                {% if value.param_name == 'filter.v.availability' and result_total_hide_product %}
                                  {% assign value_count = value_count | minus: result_total_hide_product %}
                                  {% if value_count < 0 %}
                                    {% assign value_count = 0 %}
                                  {% endif %}
                                {% endif %}
                                {{ value.label | escape }} ({{ value_count }})
                              </span>
                            </label>
                            </li>
                          {% endunless %}
						{%- endfor -%}
					  </ul>
					</div>
				{% when 'price_range' %}
				  {% liquid
					assign currencies_using_comma_decimals = 'ANG,ARS,BRL,BYN,BYR,CLF,CLP,COP,CRC,CZK,DKK,EUR,HRK,HUF,IDR,ISK,MZN,NOK,PLN,RON,RUB,SEK,TRY,UYU,VES,VND' | split: ','
					assign uses_comma_decimals = false
					if currencies_using_comma_decimals contains cart.currency.iso_code
					  assign uses_comma_decimals = true
					endif
				  %}

					<div id="Facet-{{ forloop.index }}-{{ section.id }}" class="facets__display-price facets-element js-filter" data-index="{{ forloop.index }}">
					  <div class="facets__header">
						{%- assign max_price_amount = filter.range_max | money | strip_html | escape -%}
						<span class="facets__header-title">{{ filter.label | escape }}</span>
					  </div>
                      <ul class="facets__list list-unstyled" role="list">
                        <price-range class="facets__price">
                          <div class="price-inputs">
                              <span class="field-currency">{{ cart.currency.symbol }}</span>
                              <div class="field">
                              <input class="field__input"
                                  name="{{ filter.min_value.param_name }}"
                                  id="Filter-{{ filter.label | escape }}-GTE"
                                  {%- if filter.min_value.value -%}
                                  {%- if uses_comma_decimals -%}value="{{ filter.min_value.value | money_without_currency | replace: '.', '' | replace: ',', '.' }}"{%- else -%}value="{{ filter.min_value.value | money_without_currency | replace: ',', '' }}"{% endif %}
                                  {%- endif -%}
                                  type="number"
                                  placeholder="0"
                                  min="0"
                                  {%- if uses_comma_decimals -%}max="{{ filter.range_max | money_without_currency | replace: '.', '' | replace: ',', '.' }}"{%- else -%}max="{{ filter.range_max | money_without_currency | replace: ',', '' }}"{% endif %}
                              >
                              </div>
                              <span class="field-currency">{{ cart.currency.symbol }}</span>
                              <div class="field">
                              <input class="field__input"
                                  name="{{ filter.max_value.param_name }}"
                                  id="Filter-{{ filter.label | escape }}-LTE"
                                  {%- if filter.max_value.value -%}{%- if uses_comma_decimals -%}value="{{ filter.max_value.value | money_without_currency | replace: '.', '' | replace: ',', '.' }}"{%- else -%}value="{{ filter.max_value.value | money_without_currency | replace: ',', '' }}"{% endif %}
                                  {%- endif -%}
                                  type="number"
                                  min="0"
                                  {%- if uses_comma_decimals -%}
                                  placeholder="{{ filter.range_max | money_without_currency | replace: '.', '' | replace: ',', '.' }}"
                                  max="{{ filter.range_max | money_without_currency | replace: '.', '' | replace: ',', '.' }}"
                                  {%- else -%}
                                  placeholder="{{ filter.range_max | money_without_currency | replace: ',', '' }}"
                                  max="{{ filter.range_max | money_without_currency | replace: ',', '' }}"
                                  {% endif %}
                              >
                              </div>
                          </div>
                          {% comment %}
                              <div class="facet-multi-range-container">
                                  <span class="facet-multi-range">
                                      <input
                                          type="range"
                                          min="0"
                                          max="{{ filter.max_value.value }}"
                                          value="{{ filter.min_value.value }}"
                                          id="lower"
                                      >
                                      <input
                                          type="range"
                                          min="0"
                                          max="{{ filter.max_value.value }}"
                                          value="{{ filter.max_value.value }}"
                                          id="upper"
                                      >
                                  </span>
                              </div>
                          {% endcomment %}
                        </price-range>
                      </ul>
					</div>
				{% endcase %}
			  {%- endfor -%}
			  <noscript>
				<button type="submit" class="facets__button-no-js button button--tertiary">{{ 'products.facets.filter_button' | t }}</button>
			  </noscript>
			</div>
		  {% endif %}

		  {% if results.current_vendor or results.current_type %}
			<input type="hidden" name="q" value="{{ results.current_vendor }}{{ results.current_type }}">
		  {% endif %}
		</form>
	  </facet-filters-form>
	{%- endunless -%}

	<div class="active-facets active-facets-none active-facets-mobile {% unless collapse_on_larger_devices %} medium-hide large-up-hide{% endunless %}">
	  {%- for filter in results.filters -%}
		{%- for value in filter.active_values -%}
		  <facet-remove>
			<a href="{{ value.url_to_remove }}" class="active-facets__button active-facets__button--light">
			  <span id="removeFilterMobile-{{ value.label }}" class="collection-new-filter">
				{{ value.label | escape }}
				{% render 'icon-close-small' %}
			  </span>
			</a>
		  </facet-remove>
		{%- endfor -%}

		{%- if filter.type == "price_range" -%}
		  {%- if filter.min_value.value != nil or filter.max_value.value != nil -%}
			<facet-remove>
			  <a href="{{ filter.url_to_remove }}" class="active-facets__button active-facets__button--light">
				<span id="priceRemoveFilterMobile" class="collection-new-filter">
				  {%- if filter.min_value.value -%}{{ filter.min_value.value | money }}{%- else -%}{{ 0 | money }}{%- endif -%}-{%- if filter.max_value.value -%}{{ filter.max_value.value | money }}{%- else -%}{{ filter.range_max | money }}{%- endif -%}
				  {% render 'icon-close-small' %}
				</span>
			  </a>
			</facet-remove>
		  {%- endif -%}
		{%- endif -%}
	  {%- endfor -%}
	  {% comment %}
		<facet-remove class="active-facets__button-wrapper">
			<a href="{{ results_url }}" class="active-facets__button-remove underlined-link">
			<span>{{ 'products.facets.clear_all' | t }}</span>
			</a>
		</facet-remove>
	  {% endcomment %}
	</div>
  </div>

  <script>
		document.addEventListener('DOMContentLoaded', function() {
			$("#mobileRefineBy").click(function() {
				$("#FacetsWrapperDesktop").toggleClass("facets__mobile-none");
			});
          $(".filter-close-mobile").click(function() {
                 $("#FacetsWrapperDesktop").toggleClass("facets__mobile-none");
          });
		});
  </script>
